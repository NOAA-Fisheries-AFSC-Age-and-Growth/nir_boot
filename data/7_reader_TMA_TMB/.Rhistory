if (verbose) {
print(SaveFile)
}
ReportFile <- file.path(SaveDir, paste0("/", Species, ".rpt"))
if (verbose) {
print(ReportFile)
}
load(SaveFile)
if (verbose) {
print(str(SaveAll))
}
NDataSet <- SaveAll$data$NDataSet
Index <- which(abs(SaveAll$gradient) == max(abs(SaveAll$gradient)))
Npars <- length(SaveAll$sdreport$par.fixed)
for (IDataSet in 1:NDataSet) {
Data <- SaveAll$data$TheData[IDataSet, 1:SaveAll$data$Npnt[IDataSet],
]
}
MaxAge = SaveAll$data$MaxAge
ReaderNames = NULL
Report = SaveAll$report
Nreaders <- ncol(Data) - 1
Ages <- Nages <- MaxAge + 1
MisclassArray <- array(NA, dim = c(Nreaders, Ages, Ages),
dimnames = list(paste("Reader", 1:Nreaders), paste("TrueAge",
0:MaxAge), paste("EstAge", 0:MaxAge)))
for (i in 1:Nreaders) {
MisclassArray[i, , ] <- Report$AgeErrOut[i, , ]
}
Temp <- matrix(0, nrow = 5 * Nages * Nreaders, ncol = 5)
for (Ireader in 1:Nreaders) {
yrange <- (Ireader - 1) * Nages
Temp[yrange + 1:Nages, 1] <- Ireader
Temp[yrange + 1:Nages, 2] <- 0:MaxAge
Temp[yrange + 1:Nages, 3] <- Report$TheSD[Ireader, ]/c(1,
1:MaxAge)
Temp[yrange + 1:Nages, 4] <- Report$TheSD[Ireader, ]
Temp[yrange + 1:Nages, 5] <- Report$TheBias[Ireader,
]
}
Temp <- t(Temp)
ErrorAndBiasArray <- array(as.numeric(Temp),
dim = c(5, Nages,Nreaders),
dimnames = list(c("Reader", "True_Age", "CV", "SD", "Expected_age"),
paste("Age", 0:MaxAge), paste("Reader", 1:Nreaders)))
AgeProbs <- array(NA, dim = c(nrow(Data), Ages),
dimnames = list(paste("Otolith", 1:nrow(Data)), paste("TrueAge", 0:MaxAge)))
OtI <- AgeI <- ReadI <- 1
for (OtI in 1:nrow(Data)) {
for (AgeI in 1:Ages) {
AgeProbs[OtI, AgeI] <- 1
for (ReadI in 1:Nreaders) {
if (Data[OtI, ReadI + 1] != -999) {
AgeRead <- Data[OtI, ReadI + 1]
AgeProbs[OtI, AgeI] <- AgeProbs[OtI, AgeI] *
(MisclassArray[ReadI, AgeI, AgeRead + 1])^Data[OtI,
1]
}
}
}
}
TrueAge <- apply(AgeProbs, MARGIN = 1, FUN = function(Vec) {
order(Vec[-length(Vec)], decreasing = TRUE)[1]
}) - 1
dev.new(width=10, height=10, unit="in",noRStudioGD = TRUE)
par(oma=c(3,3,0,3),mai = c(0.25,0.25,0.25,0.5),mfrow=c(4,2))
for (i in 1:Nreaders) {
{
# Add 0.5 to match convention in Punt model that otoliths are read
# half way through year
Temp <- cbind(TrueAge, Data[, i+1] + 0.5)
# Exclude rows with no read for this reader
Temp <- Temp[which(Data[, i+1] != -999), ]
plot(
x = Temp[, 1], y = Temp[, 2],
ylim = c(0, MaxAge), xlim = c(0, MaxAge),
col = grDevices::rgb(red = 0, green = 0, blue = 0, alpha = 0.2),
xlab = "",
ylab = "",
main = paste("Reader", i),
lwd = 2, frame.plot = F, pch = 16, cex = 2.5,yaxs="i",xaxs="i",axes=F
)
axis(1,at=c("",seq(0,18,by=5)),labels=c("",seq(0,18,by=5)),cex.axis=1.5)
axis(1,at=seq(0,18,by=1),labels=F,tck=-0.01)
axis(2,at=seq(0,18,by=5),labels=seq(0,17,by=5),las=1,cex.axis=1.5)
axis(2,at=seq(0,18,by=1),labels=F,tck=-0.01)
mtext(text="Predicted Age y",side=1,line=1.25,outer=TRUE,cex=1.5)
mtext(text="Read Age y",side=2,line=1.25,outer=TRUE,cex=1.5)
graphics::lines(
x = c(0, MaxAge),
y = c(0.5, MaxAge+0.5),
lwd = 2, lty = "dashed"
)
graphics::lines(
x = ErrorAndBiasArray["True_Age", , i],
y = ErrorAndBiasArray["Expected_age", , i],
type = "l", col = "red", lwd = 2
)
graphics::lines(
x = ErrorAndBiasArray["True_Age", , i],
y = ErrorAndBiasArray["Expected_age", , i] +
2 * ErrorAndBiasArray["SD", , i],
type = "l", col = "red", lwd = 2, lty = "dashed"
)
graphics::lines(
x = ErrorAndBiasArray["True_Age", , i],
y = ErrorAndBiasArray["Expected_age", , i] -
2 * ErrorAndBiasArray["SD", , i],
type = "l", col = "red", lwd = 2, lty = "dashed"
)
par(new = TRUE)
plot(x = ErrorAndBiasArray["True_Age", , i], ErrorAndBiasArray["SD", , i],
ylim = c(0, 2.5),
type = "l", yaxs="i",xaxs="i",axes=F, col = "blue", lwd = 2)
axis(4,at=seq(0,2.5,by=0.5),labels = c('0', '0.5', '1.0', '1.5', '2.0', '2.5'),las=1,cex.axis=1.5)
axis(4,at=seq(0,2.5,by=0.25),labels=F,tck=-0.01)
mtext(text="SD y",side=4,line=1.25,outer=TRUE,cex=1.5)
}
}
}
SaveFile <- file.path(SaveDir, paste0("/", Species, ".lda"))
if (verbose) {
print(SaveFile)
}
ReportFile <- file.path(SaveDir, paste0("/", Species, ".rpt"))
if (verbose) {
print(ReportFile)
}
load(SaveFile)
if (verbose) {
print(str(SaveAll))
}
NDataSet <- SaveAll$data$NDataSet
Index <- which(abs(SaveAll$gradient) == max(abs(SaveAll$gradient)))
Npars <- length(SaveAll$sdreport$par.fixed)
for (IDataSet in 1:NDataSet) {
Data <- SaveAll$data$TheData[IDataSet, 1:SaveAll$data$Npnt[IDataSet],
]
}
MaxAge = SaveAll$data$MaxAge
ReaderNames = NULL
Report = SaveAll$report
Nreaders <- ncol(Data) - 1
Ages <- Nages <- MaxAge + 1
MisclassArray <- array(NA, dim = c(Nreaders, Ages, Ages),
dimnames = list(paste("Reader", 1:Nreaders), paste("TrueAge",
0:MaxAge), paste("EstAge", 0:MaxAge)))
for (i in 1:Nreaders) {
MisclassArray[i, , ] <- Report$AgeErrOut[i, , ]
}
Temp <- matrix(0, nrow = 5 * Nages * Nreaders, ncol = 5)
for (Ireader in 1:Nreaders) {
yrange <- (Ireader - 1) * Nages
Temp[yrange + 1:Nages, 1] <- Ireader
Temp[yrange + 1:Nages, 2] <- 0:MaxAge
Temp[yrange + 1:Nages, 3] <- Report$TheSD[Ireader, ]/c(1,
1:MaxAge)
Temp[yrange + 1:Nages, 4] <- Report$TheSD[Ireader, ]
Temp[yrange + 1:Nages, 5] <- Report$TheBias[Ireader,
]
}
Temp <- t(Temp)
ErrorAndBiasArray <- array(as.numeric(Temp),
dim = c(5, Nages,Nreaders),
dimnames = list(c("Reader", "True_Age", "CV", "SD", "Expected_age"),
paste("Age", 0:MaxAge), paste("Reader", 1:Nreaders)))
AgeProbs <- array(NA, dim = c(nrow(Data), Ages),
dimnames = list(paste("Otolith", 1:nrow(Data)), paste("TrueAge", 0:MaxAge)))
OtI <- AgeI <- ReadI <- 1
for (OtI in 1:nrow(Data)) {
for (AgeI in 1:Ages) {
AgeProbs[OtI, AgeI] <- 1
for (ReadI in 1:Nreaders) {
if (Data[OtI, ReadI + 1] != -999) {
AgeRead <- Data[OtI, ReadI + 1]
AgeProbs[OtI, AgeI] <- AgeProbs[OtI, AgeI] *
(MisclassArray[ReadI, AgeI, AgeRead + 1])^Data[OtI,
1]
}
}
}
}
TrueAge <- apply(AgeProbs, MARGIN = 1, FUN = function(Vec) {
order(Vec[-length(Vec)], decreasing = TRUE)[1]
}) - 1
TrueAge
View(AgeProbs)
View(Data)
SaveDir
file.path(SaveDir)
SubDir="NIR"
dir.create(file.path(SubDir))
wd
dir.create(file.path(SubDir))
file.copy(
paste0("/", Species, ".dat"),
SubDir,
overwrite = TRUE
)
file.copy(
paste0("/", Species, ".dat"),
SubDir,
overwrite = TRUE
)
?file.copy
setwd("C:/Users/Derek.Chamberlin/Work/Research/TMA_FT_NIR_Uncertainty/Age_Error_Matrices/7_readers_complete_dataset_TMB")
dir.create(file.path(SubDir))
file.copy(
paste0("/", Species, ".dat"),
SubDir,
overwrite = TRUE
)
getwd()
paste0(getwd(),"/", Species, ".dat")
file.copy(
paste0(getwd(),"/", Species, ".dat"),
SubDir,
overwrite = TRUE
)
file.copy(
paste0(getwd(),"/", Species, ".dat"),
SubDir,
overwrite = TRUE
)
file.copy(
paste0(getwd(),"/", Species, ".spc"),
SubDir,
overwrite = TRUE
)
cbind(Data, TrueAge)
View(Data)
df <- read_excel("C:/Users/Derek.Chamberlin/Work/Research/TMA_FT_NIR_Uncertainty/Data/Pollock_Ages/Ageing_Precision_EBS_Pollock_2019_to_2023_All_Readers.xlsx")
df[,c(6,10,14,18,22,26,30)][is.na(df[,c(6,10,14,18,22,26,30)])] <- -999
rm(list=ls());  options(show.error.locations = TRUE)
library(AgeingError)
library(FSA)
library(dplyr)
library(readxl)
df <- read_excel("C:/Users/Derek.Chamberlin/Work/Research/TMA_FT_NIR_Uncertainty/Data/Pollock_Ages/Ageing_Precision_EBS_Pollock_2019_to_2023_All_Readers.xlsx")
df[,c(6,10,14,18,22,26,30)][is.na(df[,c(6,10,14,18,22,26,30)])] <- -999
View(df)
df <- df[,c(30,22,6,18,26,14,10)]
View(df)
load("C:/Users/Derek.Chamberlin/Work/Research/TMA_FT_NIR_Uncertainty/Age_Error_Matrices/7_readers_complete_dataset_TMB/workspace.RData")
setwd("C:/Users/Derek.Chamberlin/Work/Research/TMA_FT_NIR_Uncertainty/Age_Error_Matrices/7_readers_complete_dataset_TMB")
library(AgeingError)
library(FSA)
library(dplyr)
library(readxl)
df <- read_excel("C:/Users/Derek.Chamberlin/Work/Research/TMA_FT_NIR_Uncertainty/Data/Pollock_Ages/Ageing_Precision_EBS_Pollock_2019_to_2023_All_Readers.xlsx")
df[,c(6,10,14,18,22,26,30)][is.na(df[,c(6,10,14,18,22,26,30)])] <- -999
df <- df[,c(30,22,6,18,26,14,10)]
#calculate true age
SaveFile <- file.path(SaveDir, paste0("/", Species, ".lda"))
Species = "AgeingError"
SaveDir = getwd()
SubDir = getwd()
Orig_Data =
verbose = FALSE
model_pred_age <- function(Species = "AgeingError",
SaveDir = getwd(),
SubDir = getwd(),
Orig_Data = ,
#calculate true age
SaveFile <- file.path(SaveDir, paste0("/", Species, ".lda"))
if (verbose) {
print(SaveFile)
}
ReportFile <- file.path(SaveDir, paste0("/", Species, ".rpt"))
if (verbose) {
print(ReportFile)
}
load(SaveFile)
SubDir = "NIR"
Species = "Pollock"
SaveDir = "Results"
SubDir = "NIR"
Orig_Data =
verbose = FALSE
SaveFile <- file.path(SaveDir, paste0("/", Species, ".lda"))
if (verbose) {
print(SaveFile)
}
ReportFile <- file.path(SaveDir, paste0("/", Species, ".rpt"))
if (verbose) {
print(ReportFile)
}
load(SaveFile)
if (verbose) {
print(str(SaveAll))
}
NDataSet <- SaveAll$data$NDataSet
Index <- which(abs(SaveAll$gradient) == max(abs(SaveAll$gradient)))
Npars <- length(SaveAll$sdreport$par.fixed)
for (IDataSet in 1:NDataSet) {
Data <- SaveAll$data$TheData[IDataSet, 1:SaveAll$data$Npnt[IDataSet],
]
}
MaxAge = SaveAll$data$MaxAge
ReaderNames = NULL
Report = SaveAll$report
Nreaders <- ncol(Data) - 1
Ages <- Nages <- MaxAge + 1
MisclassArray <- array(NA, dim = c(Nreaders, Ages, Ages),
dimnames = list(paste("Reader", 1:Nreaders), paste("TrueAge",
0:MaxAge), paste("EstAge", 0:MaxAge)))
for (i in 1:Nreaders) {
MisclassArray[i, , ] <- Report$AgeErrOut[i, , ]
}
Temp <- matrix(0, nrow = 5 * Nages * Nreaders, ncol = 5)
for (Ireader in 1:Nreaders) {
yrange <- (Ireader - 1) * Nages
Temp[yrange + 1:Nages, 1] <- Ireader
Temp[yrange + 1:Nages, 2] <- 0:MaxAge
Temp[yrange + 1:Nages, 3] <- Report$TheSD[Ireader, ]/c(1,
1:MaxAge)
Temp[yrange + 1:Nages, 4] <- Report$TheSD[Ireader, ]
Temp[yrange + 1:Nages, 5] <- Report$TheBias[Ireader,
]
}
Temp <- t(Temp)
ErrorAndBiasArray <- array(as.numeric(Temp),
dim = c(5, Nages,Nreaders),
dimnames = list(c("Reader", "True_Age", "CV", "SD", "Expected_age"),
paste("Age", 0:MaxAge), paste("Reader", 1:Nreaders)))
AgeProbs <- array(NA, dim = c(nrow(Data), Ages),
dimnames = list(paste("Otolith", 1:nrow(Data)), paste("TrueAge", 0:MaxAge)))
OtI <- AgeI <- ReadI <- 1
for (OtI in 1:nrow(Data)) {
for (AgeI in 1:Ages) {
AgeProbs[OtI, AgeI] <- 1
for (ReadI in 1:Nreaders) {
if (Data[OtI, ReadI + 1] != -999) {
AgeRead <- Data[OtI, ReadI + 1]
AgeProbs[OtI, AgeI] <- AgeProbs[OtI, AgeI] *
(MisclassArray[ReadI, AgeI, AgeRead + 1])^Data[OtI,
1]
}
}
}
}
TrueAge <- apply(AgeProbs, MARGIN = 1, FUN = function(Vec) {
order(Vec[-length(Vec)], decreasing = TRUE)[1]
}) - 1
#match true age to original data
Data <- cbind(Data, TrueAge)
Data <- merge(Data, Orig_Data)
#calculate true age
SaveFile <- file.path(SaveDir, paste0("/", Species, ".lda"))
if (verbose) {
print(SaveFile)
}
ReportFile <- file.path(SaveDir, paste0("/", Species, ".rpt"))
if (verbose) {
print(ReportFile)
}
load(SaveFile)
if (verbose) {
print(str(SaveAll))
}
NDataSet <- SaveAll$data$NDataSet
Index <- which(abs(SaveAll$gradient) == max(abs(SaveAll$gradient)))
Npars <- length(SaveAll$sdreport$par.fixed)
for (IDataSet in 1:NDataSet) {
Data <- SaveAll$data$TheData[IDataSet, 1:SaveAll$data$Npnt[IDataSet],
]
}
MaxAge = SaveAll$data$MaxAge
ReaderNames = NULL
Report = SaveAll$report
Nreaders <- ncol(Data) - 1
Ages <- Nages <- MaxAge + 1
MisclassArray <- array(NA, dim = c(Nreaders, Ages, Ages),
dimnames = list(paste("Reader", 1:Nreaders), paste("TrueAge",
0:MaxAge), paste("EstAge", 0:MaxAge)))
for (i in 1:Nreaders) {
MisclassArray[i, , ] <- Report$AgeErrOut[i, , ]
}
Temp <- matrix(0, nrow = 5 * Nages * Nreaders, ncol = 5)
for (Ireader in 1:Nreaders) {
yrange <- (Ireader - 1) * Nages
Temp[yrange + 1:Nages, 1] <- Ireader
Temp[yrange + 1:Nages, 2] <- 0:MaxAge
Temp[yrange + 1:Nages, 3] <- Report$TheSD[Ireader, ]/c(1,
1:MaxAge)
Temp[yrange + 1:Nages, 4] <- Report$TheSD[Ireader, ]
Temp[yrange + 1:Nages, 5] <- Report$TheBias[Ireader,
]
}
Temp <- t(Temp)
ErrorAndBiasArray <- array(as.numeric(Temp),
dim = c(5, Nages,Nreaders),
dimnames = list(c("Reader", "True_Age", "CV", "SD", "Expected_age"),
paste("Age", 0:MaxAge), paste("Reader", 1:Nreaders)))
AgeProbs <- array(NA, dim = c(nrow(Data), Ages),
dimnames = list(paste("Otolith", 1:nrow(Data)), paste("TrueAge", 0:MaxAge)))
OtI <- AgeI <- ReadI <- 1
for (OtI in 1:nrow(Data)) {
for (AgeI in 1:Ages) {
AgeProbs[OtI, AgeI] <- 1
for (ReadI in 1:Nreaders) {
if (Data[OtI, ReadI + 1] != -999) {
AgeRead <- Data[OtI, ReadI + 1]
AgeProbs[OtI, AgeI] <- AgeProbs[OtI, AgeI] *
(MisclassArray[ReadI, AgeI, AgeRead + 1])^Data[OtI,
1]
}
}
}
}
TrueAge <- apply(AgeProbs, MARGIN = 1, FUN = function(Vec) {
order(Vec[-length(Vec)], decreasing = TRUE)[1]
}) - 1
#match true age to original data
Data <- cbind(Data, TrueAge)
?merge
View(Data)
ncol(Data)
Data2 <- merge(Data, Orig_Data, by.x = 2:(ncol(Data)-1), by.y = 1:ncol(Orig_Data))
Orig_Data = df
Data2 <- merge(Data, Orig_Data, by.x = 2:(ncol(Data)-1), by.y = 1:ncol(Orig_Data))
View(Data2)
Data2 <- merge(Data[,-1], Orig_Data, by.x = 2:(ncol(Data)-1), by.y = 1:ncol(Orig_Data))
Data2 <- merge(Data[,-1], Orig_Data, by.x = 1:(ncol(Data)-1), by.y = 1:ncol(Orig_Data))
Data2 <- merge(Data[,-1], Orig_Data, by.x = 1:(ncol(Data[,-1])-1), by.y = 1:ncol(Orig_Data))
Data <- Data[,c(ncol(Data),1:1:(ncol(Data)-1))]
#match true age to original data
Data <- cbind(Data, TrueAge)
#calculate true age
SaveFile <- file.path(SaveDir, paste0("/", Species, ".lda"))
if (verbose) {
print(SaveFile)
}
ReportFile <- file.path(SaveDir, paste0("/", Species, ".rpt"))
if (verbose) {
print(ReportFile)
}
load(SaveFile)
if (verbose) {
print(str(SaveAll))
}
NDataSet <- SaveAll$data$NDataSet
Index <- which(abs(SaveAll$gradient) == max(abs(SaveAll$gradient)))
Npars <- length(SaveAll$sdreport$par.fixed)
for (IDataSet in 1:NDataSet) {
Data <- SaveAll$data$TheData[IDataSet, 1:SaveAll$data$Npnt[IDataSet],
]
}
MaxAge = SaveAll$data$MaxAge
ReaderNames = NULL
Report = SaveAll$report
Nreaders <- ncol(Data) - 1
Ages <- Nages <- MaxAge + 1
MisclassArray <- array(NA, dim = c(Nreaders, Ages, Ages),
dimnames = list(paste("Reader", 1:Nreaders), paste("TrueAge",
0:MaxAge), paste("EstAge", 0:MaxAge)))
for (i in 1:Nreaders) {
MisclassArray[i, , ] <- Report$AgeErrOut[i, , ]
}
Temp <- matrix(0, nrow = 5 * Nages * Nreaders, ncol = 5)
for (Ireader in 1:Nreaders) {
yrange <- (Ireader - 1) * Nages
Temp[yrange + 1:Nages, 1] <- Ireader
Temp[yrange + 1:Nages, 2] <- 0:MaxAge
Temp[yrange + 1:Nages, 3] <- Report$TheSD[Ireader, ]/c(1,
1:MaxAge)
Temp[yrange + 1:Nages, 4] <- Report$TheSD[Ireader, ]
Temp[yrange + 1:Nages, 5] <- Report$TheBias[Ireader,
]
}
Temp <- t(Temp)
ErrorAndBiasArray <- array(as.numeric(Temp),
dim = c(5, Nages,Nreaders),
dimnames = list(c("Reader", "True_Age", "CV", "SD", "Expected_age"),
paste("Age", 0:MaxAge), paste("Reader", 1:Nreaders)))
AgeProbs <- array(NA, dim = c(nrow(Data), Ages),
dimnames = list(paste("Otolith", 1:nrow(Data)), paste("TrueAge", 0:MaxAge)))
OtI <- AgeI <- ReadI <- 1
for (OtI in 1:nrow(Data)) {
for (AgeI in 1:Ages) {
AgeProbs[OtI, AgeI] <- 1
for (ReadI in 1:Nreaders) {
if (Data[OtI, ReadI + 1] != -999) {
AgeRead <- Data[OtI, ReadI + 1]
AgeProbs[OtI, AgeI] <- AgeProbs[OtI, AgeI] *
(MisclassArray[ReadI, AgeI, AgeRead + 1])^Data[OtI,
1]
}
}
}
}
TrueAge <- apply(AgeProbs, MARGIN = 1, FUN = function(Vec) {
order(Vec[-length(Vec)], decreasing = TRUE)[1]
}) - 1
#match true age to original data
Data <- cbind(Data, TrueAge)
Data2 <- merge(Data[,-1], Orig_Data, by.x = 1:(ncol(Data[,-1])-1), by.y = 1:ncol(Orig_Data))
Data <- merge(Data[,-1], Orig_Data, by.x = 1:(ncol(Data[,-1])-1), by.y = 1:ncol(Orig_Data))
Data <- Data[,c(ncol(Data),1:1:(ncol(Data)-1))]
?count
rename(Freq = n, count(Data))
rename(Freq = n, count(Data), id = 1:5)
rename(Freq = n, count(Data, id = 1:5)
)
rename(Freq = n, count(Data, Brogan_Age, Julie_Age, Andrew_Age, Todd_Age, Beth_Age, Chris_Age, Kali_Age))
View(Data)
#need to change from names to column numbers!!!!!
#Data <- rename(Freq = n, count(Data, Brogan_Age, Julie_Age, Andrew_Age, Todd_Age, Beth_Age, Chris_Age, Kali_Age))
#Data <- Data[,c(ncol(Data),1:1:(ncol(Data)-1))]
rename(Freq = n, count(Data, Data[1:ncol(Data)]))
Data <- rename(Freq = n, count(Data, Data[1:ncol(Data)]))
Data <- Data[,c(ncol(Data),1:1:(ncol(Data)-1))]
